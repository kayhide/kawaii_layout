(function(){$(function(){var e,t,n,r,o,a,i,s,u,d,c,l,h,y,f,w,m,p,D,g,B,S,x,A,v,b,C,k,G,P,F,T,j,M,_,J,O,z,N,I,L,R,E,K;if(m=$("canvas#tumtum")[0]){for(n=10,P=!1,D=!1,I=new createjs.Stage(m),r=new createjs.Container,F=new createjs.Container,I.addChild(r),f=[],h=Box2D.Common.Math.b2Vec2,i=Box2D.Dynamics.b2BodyDef,a=Box2D.Dynamics.b2Body,d=Box2D.Dynamics.b2FixtureDef,y=Box2D.Dynamics.b2World,l=Box2D.Collision.Shapes.b2PolygonShape,s=Box2D.Collision.Shapes.b2CircleShape,u=Box2D.Dynamics.b2DebugDraw,o=Box2D.Collision.b2AABB,c=Box2D.Dynamics.Joints.b2MouseJointDef,g=$(m),C=new h(g.data("gravity-x"),g.data("gravity-y")),K=new y(C,!0),t=m.width,E=m.width/t,k=m.height/t,B=new d,B.density=1,e=$("#arts-count"),j=null,z=null,b=function(){return parseFloat($("#radius-min").val())},v=function(){return parseFloat($("#radius-max").val())},A=function(){return parseFloat($("#body-ratio").val())},w=function(){var e,t,n,r,o,s;return e=new i,e.type=a.b2_staticBody,w=K.CreateBody(e),r=.1,s=100*k,o=new d,o.shape=new l,o.shape.SetAsOrientedBox(E/2,r,new h(E/2,-r),0),t=new d,t.shape=new l,t.shape.SetAsOrientedBox(r,s,new h(-r,0),0),n=new d,n.shape=new l,n.shape.SetAsOrientedBox(r,s,new h(E+r,0),0),w.CreateFixture(o),w.CreateFixture(t),w.CreateFixture(n),w}(),S=new Gesture,S.setScale(t),S.on("mousedown",function(){var e,t;t=x(!0,S.mousePoint),t&&(S.shiftKey()&&null!=z&&z!==t?L(z,t):(p(t),O(t),e=new c,e.bodyA=w,e.bodyB=t,e.target=S.mousePoint,e.collideConnected=!0,e.maxForce=1e3*t.GetMass(),e.dampingRatio=0,j=K.CreateJoint(e),t.SetAwake(!0)))}),S.on("pressmove",function(){j&&j.SetTarget(S.mousePoint)}),S.on("pressup",function(){var e;j&&(e=j.GetBodyB(),_(e),K.DestroyJoint(j),j=null)}),S.on("longpress",function(){var e;j&&(e=j.GetBodyB(),R(e))}),L=function(e,t){var n;n=new h(e.GetPosition().x,e.GetPosition().y),e.SetPosition(t.GetPosition()),t.SetPosition(n),e.SetAwake(!0),t.SetAwake(!0)},p=function(e){return e.SetType(a.b2_dynamicBody),e.actors[0].markAsCaptured()},_=function(e){return e.frozen?(e.SetType(a.b2_staticBody),e.actors[0].markAsStatic()):e.actors[0].markAsDynamic(),z===e?e.actors[0].markAsSelected():void 0},O=function(e){var t;return t=z,z=e,null!=t&&t!==z&&_(t),null!=z?z.actors[0].markAsSelected():void 0},R=function(e){return N(e,!e.frozen)},N=function(e,t){var n;return e.frozen=t,n=e.actors[0],t?n.markAsStatic():n.markAsDynamic()},x=function(e,t){var n,r,i;return r=null,n=new o,i=function(n){var o,i,s;return i=n.GetShape(),s=n.GetBody(),(s.GetType()!==a.b2_staticBody||e)&&s!==w&&(o=i.TestPoint(s.GetTransform(),t))?(r=s,!1):!0},n.lowerBound.Set(t.x-.001,t.y-.001),n.upperBound.Set(t.x+.001,t.y+.001),K.QueryAABB(i,n),r},m.showArtsCount=function(){return e.text(f.length)},m.addActors=function(e){return r.addChild(e.actors[0]),F.addChild(e.actors[1])},m.addArt=function(){var e,n,r,o,u,d,c,l;return d=Math.random()*(v()-b())+b(),o=new i,o.type=a.b2_dynamicBody,B.shape=new s(A()*d),l=function(){var e,t,n;for(n=[],e=0,t=f.length;t>e;e++)r=f[e],NaN!==r.GetPosition().y&&n.push(r.GetPosition().y+r.radius);return n}(),c=l.length>0?Math.max.apply(null,l):d,o.position.Set(E*(.1+.8*Math.random()),c),r=K.CreateBody(o),r.CreateFixture(B),u=f.push(r),r.radius=d,e=new ArtImage(d*t,u),e.markAsDynamic(),S.attach(e),n=new Baumkuchen(d*t),r.actors=[e,n],N(r,!1),m.addActors(r),m.showArtsCount()},m.addArt10=function(){var e,t,n;for(n=[],e=t=1;10>=t;e=++t)n.push(m.addArt());return n},m.toggleImages=function(){return P=!P,P?(r.remove(),I.addChildAt(F,0)):(I.addChildAt(r,0),F.remove()),P},m.toggleDebug=function(){return D=!D,D&&!this.debugDraw&&(this.debugDraw=new u,this.debugDraw.SetSprite(m.getContext("2d")),this.debugDraw.SetDrawScale(t),this.debugDraw.SetFillAlpha(.3),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(u.e_shapeBit|u.e_jointBit),K.SetDebugDraw(this.debugDraw)),D},m.reset=function(){var e,t,n;for(t=0,n=f.length;n>t;t++)e=f[t],K.DestroyBody(e),r.removeChild(e.actors[0]),F.removeChild(e.actors[1]);return f=[],m.showArtsCount(),!1},m.dump=function(){var e,t,n;return n=function(){var t,n,r;for(r=[],t=0,n=f.length;n>t;t++)e=f[t],r.push({x:e.GetPosition().x,y:e.GetPosition().y,radius:e.radius});return r}(),t={count:n.length,elements:n},$("#output").text(JSON.stringify(t))},createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",function(e){var n,r,o,a,i,s,u,d;if(K.Step(1/60,3,3),K.ClearForces(),D)return K.DrawDebugData();for(o=0,i=f.length;i>o;o++)if(r=f[o],u=r.GetPosition(),u&&null!=u.x&&null!=u.y)for(d=r.actors,a=0,s=d.length;s>a;a++)n=d[a],n.x=u.x*t,n.y=u.y*t;return I.update(e)}),J=[],G=T=0,M=n;M>=0?M>T:T>M;G=M>=0?++T:--T)J.push(m.addArt());return J}})}).call(this);