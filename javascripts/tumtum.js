(function(){$(function(){var e,t,n,r,a,o,i,s,u,d,c,h,l,y,p,w,g,D,f,B,m,b,x,v,S,C,A,F,G,T,k,M,_,j,P,J,L,E,O,N,I;if(g=$("canvas#tumtum")[0]){for(n=10,k=!1,D=!1,E=new createjs.Stage(g),r=new createjs.Container,M=new createjs.Container,E.addChild(r),p=[],l=Box2D.Common.Math.b2Vec2,i=Box2D.Dynamics.b2BodyDef,o=Box2D.Dynamics.b2Body,d=Box2D.Dynamics.b2FixtureDef,y=Box2D.Dynamics.b2World,h=Box2D.Collision.Shapes.b2PolygonShape,s=Box2D.Collision.Shapes.b2CircleShape,u=Box2D.Dynamics.b2DebugDraw,a=Box2D.Collision.b2AABB,c=Box2D.Dynamics.Joints.b2MouseJointDef,f=$(g),S=new l(f.data("gravity-x"),f.data("gravity-y")),I=new y(S,!0),t=g.width,N=g.width/t,G=g.height/t,B=new d,B.density=1,e=$("#arts-count"),P=new l,j=null,v=function(){return parseFloat($("#radius-min").val())},x=function(){return parseFloat($("#radius-max").val())},b=function(){return parseFloat($("#body-ratio").val())},w=function(){var e,t,n,r,a,s;return e=new i,e.type=o.b2_staticBody,w=I.CreateBody(e),r=.1,s=100*G,a=new d,a.shape=new h,a.shape.SetAsOrientedBox(N/2,r,new l(N/2,-r),0),t=new d,t.shape=new h,t.shape.SetAsOrientedBox(r,s,new l(-r,0),0),n=new d,n.shape=new h,n.shape.SetAsOrientedBox(r,s,new l(N+r,0),0),w.CreateFixture(a),w.CreateFixture(t),w.CreateFixture(n),w}(),C=function(e){var n,r,a,i;a=e.stageX,i=e.stageY,P.Set(a/t,i/t),r=m(!0),r&&(r.GetType()===o.b2_staticBody&&O(r),n=new c,n.bodyA=w,n.bodyB=r,n.target=P,n.collideConnected=!0,n.maxForce=1e3*r.GetMass(),n.dampingRatio=0,j=I.CreateJoint(n),r.SetAwake(!0))},A=function(e){var n,r;n=e.stageX,r=e.stageY,P.Set(n/t,r/t),j&&j.SetTarget(P)},F=function(e){this.onMouseMove=this.onMouseUp=null,j&&(O(j.GetBodyB()),I.DestroyJoint(j),j=!1)},O=function(e){var t;return e?(t=e.actors[0],e.GetType()===o.b2_staticBody?(e.SetType(o.b2_dynamicBody),t.markAsDynamic()):(e.SetType(o.b2_staticBody),t.markAsStatic())):void 0},m=function(e){var t,n,r;return n=null,t=new a,r=function(t){var r,a,i;return a=t.GetShape(),i=t.GetBody(),(i.GetType()!==o.b2_staticBody||e)&&i!==w&&(r=a.TestPoint(i.GetTransform(),P))?(n=i,!1):!0},t.lowerBound.Set(P.x-.001,P.y-.001),t.upperBound.Set(P.x+.001,P.y+.001),I.QueryAABB(r,t),n},g.showArtsCount=function(){return e.text(p.length)},g.addActors=function(e){return r.addChild(e.actors[0]),M.addChild(e.actors[1])},g.addArt=function(){var e,n,r,a,u,d,c,h;return d=Math.random()*(x()-v())+v(),a=new i,a.type=o.b2_dynamicBody,B.shape=new s(b()*d),h=function(){var e,t,n;for(n=[],e=0,t=p.length;t>e;e++)r=p[e],NaN!==r.GetPosition().y&&n.push(r.GetPosition().y+r.radius);return n}(),c=h.length>0?Math.max.apply(null,h):d,a.position.Set(N*(.1+.8*Math.random()),c),r=I.CreateBody(a),r.CreateFixture(B),u=p.push(r),r.radius=d,e=new ArtImage(d*t,u),e.markAsDynamic(),e.addEventListener("mousedown",C),e.addEventListener("pressmove",A),e.addEventListener("pressup",F),n=new Baumkuchen(d*t),r.actors=[e,n],g.addActors(r),g.showArtsCount()},g.addArt10=function(){var e,t,n;for(n=[],e=t=1;10>=t;e=++t)n.push(g.addArt());return n},g.toggleImages=function(){return k=!k,k?(r.remove(),E.addChildAt(M,0)):(E.addChildAt(r,0),M.remove()),k},g.toggleDebug=function(){return D=!D,D&&!this.debugDraw&&(this.debugDraw=new u,this.debugDraw.SetSprite(g.getContext("2d")),this.debugDraw.SetDrawScale(t),this.debugDraw.SetFillAlpha(.3),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(u.e_shapeBit|u.e_jointBit),I.SetDebugDraw(this.debugDraw)),D},g.reset=function(){var e,t,n;for(t=0,n=p.length;n>t;t++)e=p[t],I.DestroyBody(e),r.removeChild(e.actors[0]),M.removeChild(e.actors[1]);return p=[],g.showArtsCount(),!1},g.dump=function(){var e,t,n;return n=function(){var t,n,r;for(r=[],t=0,n=p.length;n>t;t++)e=p[t],r.push({x:e.GetPosition().x,y:e.GetPosition().y,radius:e.radius});return r}(),t={count:n.length,elements:n},$("#output").text(JSON.stringify(t))},createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",function(e){var n,r,a,o,i,s,u,d;if(I.Step(1/60,3,3),I.ClearForces(),D)return I.DrawDebugData();for(a=0,i=p.length;i>a;a++)if(r=p[a],u=r.GetPosition(),u&&null!=u.x&&null!=u.y)for(d=r.actors,o=0,s=d.length;s>o;o++)n=d[o],n.x=u.x*t,n.y=u.y*t;return E.update(e)}),L=[],T=_=0,J=n;J>=0?J>_:_>J;T=J>=0?++_:--_)L.push(g.addArt());return L}})}).call(this);